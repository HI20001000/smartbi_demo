# SmartBI Demo 流程說明（v1）

本文整理目前專案中「使用者輸入 → 正規化 JSON → 驗證」的實際流程，方便後續調整規則或替換模組。

---

## 1. 入口（`src/app.py`）

在 CLI 模式下，系統會讀取使用者輸入，並先準備兩段上下文：

> 補充：CLI（Command Line Interface）模式就是「命令列互動模式」，
> 也就是直接在終端機執行程式，透過文字輸入/輸出和系統互動，
> 不經過 Web 頁面或 App UI。此專案由 `src/app.py` 的 `run_cli()` 進入這個模式。

- `request_context`
  - `request_id`
  - `request_ts`
  - `timezone`（目前預設 `Asia/Macau`）
  - `channel`（CLI）
- `user_context`
  - `user_id`
  - `role`
  - `data_scope`
  - `allowed_regions`

接著呼叫：

```python
normalize_input(text_for_normalize, user_context, request_context)
```

若 `normalize` 成功會輸出標準化 JSON；若失敗會顯示 `NormalizationError`。

---

## 2. 正規化主流程（`src/normalization/normalizer.py`）

`normalize_input(...)` 內部流程分成兩段：

1. `build_normalized_request(...)`：組裝標準化請求 JSON。
2. `validate_normalized_request(...)`：驗證 JSON 結構與欄位。

驗證失敗時，會將錯誤訊息組成字串並拋出 `NormalizationError`。

---

## 3. 規則引擎細節（`src/normalization/rule_engine.py`）

`build_normalized_request(...)` 依序做以下事情：

### 3.1 文字標準化 `_normalize_text`

- `strip()` 去頭尾空白
- 合併多空白為單一空白
- 固定詞彙替換（例如：`期末餘額 -> 存款餘額`）

### 3.2 語言偵測 `_detect_language`

- 如果有中文字符，回傳 `zh-TW`
- 否則回傳 `en`

### 3.3 意圖分類 `_detect_intent`

使用關鍵字規則判斷：

- `detail_request`
- `trend`
- `comparison`
- `kpi_query`
- `out_of_scope`

### 3.4 時間片語解析 `parse_time_phrase`

呼叫 `time_parser.py` 將自然語言時間轉成結構化區間：

- `type`
- `start_date`
- `end_date`

若沒有命中時間片語，`resolved` 會是 `None`。

### 3.5 指標目錄載入 `load_metric_catalog`

從 `semantic/metrics.yaml` 讀取可用指標，包含：

- `metric_id` / `concept_id`
- 中文/英文名稱
- `aliases`
- 中文定義

### 3.6 指標提示檢索 `retrieve_metric_hints`

根據 `normalized_text` 與 catalog 做匹配打分，輸出前幾名候選指標（預設 top 3）。

### 3.7 風險旗標 `_risk_flags`

依輸入與時間結果判斷風險，例如：

- `pii_requested`
- `account_level_detail_requested`
- `customer_level_detail_requested`
- `missing_time_filter`
- `cross_currency_aggregation_risk`

### 3.8 組裝最終 JSON

最後輸出包含：

- `schema_version`
- `request_id`
- `request_context`
- `user_context`
- `query_context`
- `time_context`
- `risk_context`
- `metric_hints`
- `normalization_trace`
- `missing_required_fields`

---

## 4. 時間解析器（`src/normalization/time_parser.py`）

目前支援常見片語（中英混合），例如：

- 今天 / today
- 昨天 / yesterday
- 近7天 / last 7 days
- 本月 / this month
- 今年 / this year
- 上月 / last month

命中後回傳 `TimeParseResult(original_phrase, resolved)`；未命中則兩者為 `None`。

---

## 5. JSON 驗證器（`src/normalization/validator.py`）

`validate_normalized_request(...)` 會：

1. 讀取 `contracts/normalized_request.schema.json`。
2. 檢查最上層 required keys。
3. 檢查 `schema_version == "1.0"`。
4. 驗證：
   - `request_context`
   - `query_context`（語言/意圖值）
   - `time_context`（日期格式與 type）
   - `missing_required_fields` 型別

回傳 `(ok, errors)`：

- `ok=True`：資料可用
- `ok=False`：由上層轉為 `NormalizationError`

---

## 6. 總結（端到端）

流程可以簡化成：

1. 入口注入 context
2. 規則引擎正規化
3. 補出時間/指標/風險訊息
4. 產生 normalized request JSON
5. 依 schema 與規則驗證
6. 回傳結果或錯誤

這份文件為第一版，後續若加入：

- 更細緻語言偵測
- 可配置意圖分類器
- 指標檢索向量化
- 多時區與財務曆支援

可再擴充成 v2 設計稿。
